"use strict";const p=require("@codemirror/view"),o=require("markedit-api"),R=require("@codemirror/state"),b=(t,e={})=>t??e,D=b(o.MarkEdit.userSettings),l=b(D["extension.markeditAIWriter"]),y=l.keyboardShortcut??"Mod-Alt-/",I=l.showsTooltip??!0,B=l.streaming??!1,q=l.instructions??"You are a writing assistant specialized in rewriting text. Always return only the rewritten or improved version of the input while strictly preserving any Markdown formatting (including headings, lists, links, and inline styles). Do not add explanations, instructions, or commentaryâ€”output only the content itself.",f=l.generationOptions??{},z=l.customWriters??[],k=".cm-selectionBackground",c={isLoading:!1},x=document.createElement("style");x.textContent=`${k} { transition: opacity 0.4s; }`;document.head.append(x);function $(){c.isLoading=!0,v()}function O(){c.isLoading=!1,v()}function V(){return c.isLoading}function v(){const t=Array.from(document.querySelectorAll(k));for(const e of t)e.style.opacity=c.isLoading?"0.4":"1.0"}const r={white:"#FFFFFF",gray:"#DDDDDD",blue1:"#0088FF",blue2:"#0091FF",blue3:"#339DFF",blue4:"#26A1FF"};function W(t){const e=R.StateField.define({create:a,update:(n,i)=>!i.docChanged&&!i.selection?n:a(i.state),provide:n=>p.showTooltip.computeN([n],i=>i.field(n))});function a(n){const i=n.selection.main;return i.empty||n.sliceDoc(i.from,i.to).trim().length===0?[]:[{pos:i.head,above:!1,strictSide:!0,arrow:!0,create:()=>{const s=document.createElement("div");return s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="15" xmlns:v="https://vecta.io/nano"><path d="M6.895 15c-.082 0-.152-.027-.211-.082a.36.36 0 0 1-.107-.22l-.321-1.812c-.115-.489-.267-.891-.457-1.207s-.44-.568-.749-.756-.703-.341-1.181-.457-1.067-.22-1.768-.312c-.095-.009-.171-.044-.227-.105a.32.32 0 0 1-.084-.224.31.31 0 0 1 .084-.217c.056-.061.132-.096.227-.105l1.771-.283c.48-.11.876-.261 1.187-.454s.562-.449.752-.769.343-.727.457-1.22.217-1.101.308-1.825c.013-.088.049-.159.107-.214s.129-.082.211-.082.158.027.214.082.093.126.11.214l.308 1.825c.115.493.266.9.454 1.22s.438.577.749.769.707.344 1.187.454 1.072.204 1.777.283a.33.33 0 0 1 .221.105.31.31 0 0 1 .084.217.32.32 0 0 1-.084.224.33.33 0 0 1-.221.105l-1.777.283c-.48.11-.876.26-1.187.45s-.561.446-.749.766-.339.728-.454 1.223-.217 1.103-.308 1.822c-.017.092-.054.165-.11.22S6.982 15 6.895 15zM2.497 7.727c-.13 0-.203-.072-.221-.217l-.165-1.032c-.058-.25-.151-.437-.279-.562s-.318-.22-.571-.286-.6-.136-1.041-.21C.074 5.397 0 5.322 0 5.195S.065 5 .195 4.978l1.051-.233c.255-.068.448-.163.577-.286s.225-.306.285-.549.117-.584.169-1.023c.017-.145.091-.217.221-.217s.203.07.221.21l.172 1.046c.058.254.151.446.279.575s.319.225.574.286.608.125 1.057.191c.056.004.103.026.139.066s.055.09.055.151c0 .123-.065.197-.195.224l-1.054.233c-.253.068-.443.164-.571.289s-.222.31-.282.556-.119.587-.175 1.026c-.009.057-.032.105-.071.145a.2.2 0 0 1-.149.059zm3.139-4.524c-.082 0-.13-.044-.143-.132l-.133-.631a.77.77 0 0 0-.169-.352c-.076-.081-.191-.146-.347-.194a5.45 5.45 0 0 0-.655-.145c-.086-.018-.13-.068-.13-.151s.043-.127.13-.145l.655-.148a.76.76 0 0 0 .347-.191.77.77 0 0 0 .169-.352l.133-.631C5.507.044 5.555 0 5.637 0s.125.044.143.132l.13.631c.039.153.096.271.172.352a.76.76 0 0 0 .347.191c.156.046.374.095.655.148.086.018.13.066.13.145s-.043.134-.13.151l-.655.145c-.156.048-.271.113-.347.194s-.133.198-.172.352l-.13.631c-.017.088-.065.132-.143.132z" fill="currentColor"/></svg>',s.className=m,s.title="AI Writer"+(y==="Mod-Alt-/"?" (Option-Command-/)":""),s.ariaLabel=s.title,s.onclick=t,{dom:s,offset:{x:2,y:0}}}}]}o.MarkEdit.addExtension([e,P])}function u(t){V()||t&&t.target?.closest(`.${m}`)!==null||(d.timeoutId!==void 0&&clearTimeout(d.timeoutId),d.timeoutId=setTimeout(()=>{E(e=>e.add(C))},300))}function M(){E(t=>t.remove(C))}function E(t){document.querySelectorAll(`.${m}`).forEach(e=>t(e.classList)),o.MarkEdit.editorView.focus()}const d={},m="cm-tooltip-selection",C="visible",P=p.EditorView.baseTheme({".cm-tooltip-arrow":{top:"-5px !important",left:"5px !important"},".cm-tooltip.cm-tooltip-selection":{opacity:"0",transform:"scale(0.6)",pointerEvents:"none",transition:"opacity 0.2s ease, transform 0.2s cubic-bezier(0.68, -0.55, 0.27, 1.55)",cursor:"pointer",padding:"3px 6px 0px 6px",border:"none",borderRadius:"5px",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.16), 0 8px 24px rgba(0, 0, 0, 0.12)",color:r.white,"& .cm-tooltip-arrow:after":{borderBottomColor:"transparent"},backgroundColor:r.blue1,"& .cm-tooltip-arrow:before":{borderBottomColor:r.blue1}},".cm-tooltip.cm-tooltip-selection.visible":{opacity:"1",transform:"scale(1)",pointerEvents:"auto"},".cm-tooltip.cm-tooltip-selection:active":{color:r.gray},".cm-tooltip.cm-tooltip-selection:hover":{backgroundColor:r.blue3,"& .cm-tooltip-arrow:before":{borderBottomColor:r.blue3}},"&dark .cm-tooltip.cm-tooltip-selection":{backgroundColor:r.blue2,"& .cm-tooltip-arrow:before":{borderBottomColor:r.blue2}},"&dark .cm-tooltip.cm-tooltip-selection:hover":{backgroundColor:r.blue4,"& .cm-tooltip-arrow:before":{borderBottomColor:r.blue4}}}),N=[{title:"Automatic Rewrite",icon:"wand.and.sparkles",prompt:"Rewrite the following text to make it clearer and more natural, preserving its original meaning:"},{title:"Elaborate",icon:"text.badge.plus",prompt:"Expand the following text, adding details, explanations, and examples while keeping the meaning consistent:"},{title:"Summarize",icon:"text.badge.minus",prompt:"Summarize the following text in fewer words, keeping only the essential ideas:"},{title:"Clear Formatting",icon:"eraser",prompt:"Remove all Markdown formatting from the following text and return plain, unformatted text only:"}],g=o.MarkEdit.editorAPI,T=o.MarkEdit.languageModel("Apple-Foundation-Models"),H=(async()=>await T.createSession({instructions:q}))(),A=[{title:"Propose Change",icon:"character.cursor.ibeam",action:async()=>{const t=await o.MarkEdit.showTextBox({title:"Describe your change"});t!==void 0&&await F(t)}},{separator:!0},...w(N),{separator:!0},...w(z)];o.MarkEdit.addMainMenuItem({title:"AI Writer",icon:"sparkles",children:[...A,{separator:!0},{title:"Version 1.0.0",state:()=>({isEnabled:!1})},{title:"Check Releases (GitHub)",action:()=>open("https://github.com/MarkEdit-app/MarkEdit-ai-writer/releases/latest")}]});o.MarkEdit.addExtension(p.keymap.of([{key:y,run:()=>(S(),!0)}]));o.MarkEdit.onEditorReady(()=>{const t=o.MarkEdit.editorView.contentDOM;t.addEventListener("mouseup",u),t.addEventListener("keyup",u),t.addEventListener("contextmenu",M)});I&&W(t=>{const e=window.visualViewport?.scale??1,a={x:(t.clientX-8)*e,y:(t.clientY-8)*e};S(a)});async function F(t){const e=await T.availability();if(e.unavailableReason!==void 0){const i=e.unavailableReason==="Model Not Ready"?"The model is being downloaded, please try again later.":"The model is not available, please visit the Apple official website for more information.";o.MarkEdit.showAlert({title:e.unavailableReason,message:i});return}const a=await H;if(await a.isResponding()){o.MarkEdit.showAlert({title:"Session Busy",message:"The session is handling another request at the moment."});return}$();const n=Y(t);B?a.streamResponseTo(n,f,h):h(await a.respondTo(n,f))}function h(t){t.error!==void 0?o.MarkEdit.showAlert({title:"Request Failed",message:t.error}):t.content!==void 0&&g.setText(t.content,L()),t.done&&(O(),u())}function w(t){return t.filter(e=>e.title&&e.prompt).map(e=>({title:e.title,icon:e.icon,action:()=>F(e.prompt)}))}function S(t){M(),o.MarkEdit.showContextMenu(A,t)}function L(){return g.getSelections()[0]}function Y(t){const e=g.getText(L());return e.length>0?`${t}

${e}`:t}
